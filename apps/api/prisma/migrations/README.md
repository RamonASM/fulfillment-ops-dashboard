# Database Migrations

This directory contains Prisma database migrations for the Fulfillment Operations Dashboard.

## Quick Start

### Apply All Migrations

```bash
# From the project root
cd apps/api

# Apply migrations
npx prisma migrate deploy

# Generate Prisma Client
npx prisma generate
```

### Using the Helper Script

```bash
# Make script executable (first time only)
chmod +x prisma/migrations/apply-all-migrations.sh

# Run the script
./prisma/migrations/apply-all-migrations.sh
```

## Migration Order

Migrations must be applied in chronological order:

1. `20251215000001_add_financial_tracking` - Budget and cost tracking
2. `20251215000002_add_shipment_tracking` - Shipment and carrier tracking
3. `20251215000003_add_benchmarking` - Cross-client benchmarking
4. `20251215000004_add_dashboard_personalization` - Custom dashboards
5. `20251215000005_add_product_lead_times` - Lead time management

## After Migration

### 1. Populate Initial Data

Run the data population script to set default values:

```bash
npx ts-node prisma/migrations/populate-initial-data.ts
```

This will:

- Set default cost sources for products
- Calculate initial lead times
- Create default dashboard layouts
- Set user preferences
- Assign benchmark cohorts
- Calculate timing metrics

### 2. Restart Application

```bash
# Development
npm run dev

# Production
pm2 restart all
```

### 3. Verify

```bash
# Check migration status
npx prisma migrate status

# Verify tables exist
psql $DATABASE_URL -c "\dt"
```

## Migration Files

Each migration directory contains:

- `migration.sql` - SQL statements to apply the migration
- Auto-generated by Prisma or manually created

## Helper Scripts

### apply-all-migrations.sh

Applies all pending migrations with safety checks and confirmation prompts.

### rollback-template.sh

Generates a template for creating rollback migrations.

### populate-initial-data.ts

Populates default values for new fields after migration.

## Common Commands

```bash
# Check migration status
npx prisma migrate status

# Apply pending migrations
npx prisma migrate deploy

# Create new migration from schema changes
npx prisma migrate dev --name migration_name

# Generate Prisma Client
npx prisma generate

# Reset database (CAUTION: deletes all data)
npx prisma migrate reset

# View applied migrations
npx prisma migrate history
```

## Rollback

To rollback a migration, create a new migration with reverse changes:

```bash
# Use the template
./prisma/migrations/rollback-template.sh

# Or create manually
npx prisma migrate dev --name rollback_feature_name

# Edit the generated migration.sql file
# Add SQL to reverse the changes
```

See `MIGRATION_GUIDE.md` for detailed rollback SQL templates.

## Production Deployment

1. **Backup database**

   ```bash
   pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Test on staging**

   ```bash
   DATABASE_URL=$STAGING_URL npx prisma migrate deploy
   ```

3. **Apply to production**

   ```bash
   DATABASE_URL=$PRODUCTION_URL npx prisma migrate deploy
   ```

4. **Verify and restart**
   ```bash
   npx prisma migrate status
   pm2 restart all
   ```

## Troubleshooting

### Migration fails with "relation already exists"

The migration was partially applied. Either:

- Drop the objects manually and retry
- Create a custom migration to reconcile

### Foreign key constraint errors

Ensure migrations run in order and referenced tables exist.

### Trigger/function errors

Check PostgreSQL version. Requires PostgreSQL 11+.

### Prisma Client out of sync

Regenerate after migrations:

```bash
npx prisma generate
```

## Documentation

- Full guide: `MIGRATION_GUIDE.md`
- Prisma docs: https://www.prisma.io/docs/concepts/components/prisma-migrate
- PostgreSQL docs: https://www.postgresql.org/docs/

## Support

For issues or questions:

1. Check `MIGRATION_GUIDE.md` for detailed information
2. Review error logs
3. Check Prisma documentation
4. Contact development team
